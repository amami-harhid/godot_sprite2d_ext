■ 2025/12/13 プロトタイプ初期版
次の不具合あり。
・ SVG画像（大）のスプライトによる衝突判定を行うと ドラッグ速度が遅くなる
・ 衝突判定の相手のコスチュームを切り替えると、当たっていないのに当たり判定をする（コスチューム１個だけのときは問題なしに見える）

■ 2025/12/19 改修
・ SVG画像（大）のスプライトによる衝突判定
画像を囲む矩形(Rect2)内のすべてのピクセルを走査して、「見える点」を特定し、「相手と重なるか？」の当たり判定をしているところを、
X軸方向に飛び飛びのピクセルにて「当たり判定」を行うことにした。これにより「当たり判定」数を圧縮した。Y軸方向にも圧縮したいがこれは未了。
・コスチュームの切り替えは、ImageTextureであるSprite2D.textureへのset_iamge()にて画像を入れ替えているのだが、
複数回のset_image()を繰り返しても、画像を囲む矩形(Rect2)の情報は初回のset_image()のときより変化しないようである。
画像ごとにImageTextureのインスタンスを保持しておき、Sprite2D.texture　自体を入れ替えることで、画像ごとの矩形(Rect2)を取得できるようになり
当たっていないのに当たり判定をする問題は解消された

■ 2025/12/20 改修
当たり判定確認を行うピクセル対象を、X軸と同様にY軸方向にも圧縮する。
X並びの圧縮は 15%程度の圧縮(PixelSpacing=10のとき)。
befor tuning size=48097
after tuning size=6580, %=13.6806869451317

さらにY並びの圧縮は 13%程度の圧縮(PixelSpacing=10のとき)。
befor tuning size=48097
after tuning size=6044, %=12.5662723246772

■ 2025/12/20 改修
Niwatori を ずっと回転し続けているとき、次の場合のNiwatori回転速度が異なる
(1) CrabがNiwatoriから十分に離れているとき
(2) CrabがNiwatoriに近いとき（重なっていない）: (1)より回転が遅くなる
(3) CrabがNiwatoriに触れているとき: (1)と同じ回転速度に見える
CrabがNiwatoriに近いときに無駄な処理をしているのかもしれない。
--> (2)はCrab側のピクセルを走査して衝突判定をしている。近いが重なっていない(2)のときは対象ピクセルを最後まで全走査するため
(1)(3)に比べて時間がかかる。

再現条件は次のとおり

Crab SvgScale = 5.0
Crab PixelSpacing = 10
Crab NeighborhoodValue = 10

Niwatori SvgScale = 3.0
Niwatori PixelSpacing = 10
Niwatori NeighborhoodValue = 10

【対処】
Node2D 側で FPS=30 としてみた。
通常の _process １回ごとに起動すると速すぎて、ピクセル全走査がフレーム１回に収まらない。

const TIME: float = 1.0/30
var timer = 0
# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(delta: float) -> void:
	timer += delta
	if timer > TIME:
		timer -= TIME
		signal_process_loop.emit()
	pass
	
■ 2025/12/20 (改修)
Neighborhood 判定条件、改良の余地ありの気がする。
見た目的に十分に離れている感じのときでも 衝突判定（ピクセル走査）を始めてしまう。
矩形の中心からみて 一番離れている点（ピクセル）を探し、その点と中心の距離を使用するとよいかもしれない。

上記のとおり、改修した。
その結果、今までより近づいても 近傍と判定されず、ぎりぎりまで近づいてもピクセル走査が走らないようになった。

■ 2025/12/22 (改修)
衝突判定は「外周」（透明・不透明の境目）のピクセルを抽出し、外周の点だけで接触判定をするとした。
判定する点の数が大幅に減ったので、大幅に速度向上したはず。

■ 2025/12/25 (改修)
クローン多数時における速度低下を避けるため次のメモリ節約対策を実施した。
クローンスプライトは、画像情報を保持せず、クローン側でコスチューム操作、衝突判定を行うときには
本体スプライトにある画像情報を参照して使うようにした。

■ 2025/12/25 (改修)
SpriteUtils#clone() を作成した

■ 改修予定
生きているクローン（弾）の数が多いとき
await signal (同じシグナル)の数が多くなってくる
すると、速度が遅くなってくる
なんとか速度を一定にできないか？

非同期ループ＋await でなく、_physics_process のなかで、ループ処理単発を繰り返すと遅くはならない
シグナル数が多いと遅くなる?

正解そうな見立ては次のとおり。
生きているクローン（弾）の数が多いとき、衝突判定の回数が多くなる。
衝突判定の瞬間時間も多くなる。待ちが増加していくことにより、全体速度が遅くなるように見える。

==> 衝突判定をしても待ちが発生しない、すなわち 非同期にできないものか？
==> 難しいので一旦あきらめる

■ 2025/12/27 (改修)
衝突判定する外周の点を、最低限に絞り込むことにより、衝突判定に要する時間を短縮させた
相手画像を囲む矩形(Rect2)にある４頂点座標を自分のローカル座標へ変換、
4頂点座標で構成する矩形が傾いている前提の元、4頂点座標を囲む矩形A(Rect2)を
作り、矩形Aと自画像矩形(Rect2)の重なる矩形B(Rect2)を作る
外周の点のうち、矩形Bに含まれる点のみを使って、衝突判定を行う。
これにより衝突判定対象の点の数を減らすことができる。

■ 2026/01/03 (改修)
衝突判定する外周の点を、最低限に絞り込むことにより、衝突判定に要する時間を短縮させた
前回改修では回転具合によっては矩形Aに比べ矩形Bが大きくなることがある
相手画像を囲む矩形(Rect2)にある４頂点座標を自分のローカル座標へ変換し、
この４頂点で構成される長方形Cと自画像矩形Dとの重なり判定をすることとする
外周の点のうち、長方形Cに含まれる点のみを使って、衝突判定を行う。
長方形Cの大きさは、前回改修の矩形Bより大きくはならないため、衝突判定対象の点の数を
減らすことができる（計測した結果 衝突判定時間がおおそ半分程度に減った）

■ 2026/01/07(改修)
スプライトに collision_space:Vector2i を追加
近傍判定： collision_spaceの指定したサイズ分、近傍判定を甘くする。
衝突判定： collision_spaceの指定したサイズ分、遠くても衝突したとする。
